<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Snowflake Stats</title>
    <meta http-equiv="refresh" content="60">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: #0d1117; 
            color: #c9d1d9; 
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat { 
            background: #161b22; 
            padding: 30px; 
            border-radius: 12px; 
            border: 1px solid #30363d;
        }
        .big { 
            font-size: 48px; 
            font-weight: bold; 
            color: #58a6ff; 
            margin-top: 10px;
        }
        .label { 
            color: #8b949e; 
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #30363d;
        }
        .metric-row:last-child {
            border-bottom: none;
        }
        table { 
            width: 100%; 
            margin-top: 20px; 
            border-collapse: collapse;
        }
        th, td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #30363d;
        }
        th { 
            background: #0d1117; 
            color: #8b949e;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }
        tr:hover { background: #1c2128; }
        .error { color: #f85149; }
        .success-rate {
            color: #3fb950;
        }
        .fail-rate {
            color: #f85149;
        }
        .flag {
            font-size: 20px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="grid">
        <div class="stat">
            <div class="label">Total Connections</div>
            <div class="big" id="total">-</div>
        </div>
        <div class="stat">
            <div class="label">Connection Timeouts</div>
            <div class="big" id="timeouts">-</div>
        </div>
        <div class="stat">
            <div class="label">Success Rate</div>
            <div class="big success-rate" id="success-rate">-</div>
        </div>
    </div>

    <div class="grid">
        <div class="stat">
            <div class="label">Network Stats</div>
            <div class="metric-row">
                <span>Inbound Traffic</span>
                <span id="inbound">-</span>
            </div>
            <div class="metric-row">
                <span>Outbound Traffic</span>
                <span id="outbound">-</span>
            </div>
            <div class="metric-row">
                <span>Memory Usage</span>
                <span id="memory">-</span>
            </div>
            <div class="metric-row">
                <span>Uptime</span>
                <span id="uptime">-</span>
            </div>
        </div>
        
        <div class="stat">
            <div class="label">Connections by Country</div>
            <table id="countries">
                <tr><th>Country</th><th>Count</th></tr>
            </table>
        </div>
    </div>
    
    <script>
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m`;
        }
        
        function getFlag(countryCode) {
            if (!countryCode || countryCode === 'Unknown') return 'ðŸŒ';
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }
        
        async function fetchStats() {
            try {
                const response = await fetch('/internal/metrics');
                const text = await response.text();
                
                let total = 0;
                let timeouts = 0;
                let inbound = 0;
                let outbound = 0;
                let memory = 0;
                let startTime = 0;
                const countries = {};
                
                text.split('\n').forEach(line => {
                    if (line.startsWith('tor_snowflake_proxy_connections_total')) {
                        const match = line.match(/country="([^"]*)".*?(\d+)$/);
                        if (match) {
                            const country = match[1] || 'Unknown';
                            const count = parseInt(match[2]);
                            countries[country] = count;
                            total += count;
                        }
                    } else if (line.startsWith('tor_snowflake_proxy_connection_timeouts_total')) {
                        const match = line.match(/(\d+)$/);
                        if (match) timeouts = parseInt(match[1]);
                    } else if (line.startsWith('process_network_receive_bytes_total')) {
                        const match = line.match(/(\d+\.?\d*e?\+?\d*)$/);
                        if (match) inbound = parseFloat(match[1]);
                    } else if (line.startsWith('process_network_transmit_bytes_total')) {
                        const match = line.match(/(\d+\.?\d*e?\+?\d*)$/);
                        if (match) outbound = parseFloat(match[1]);
                    } else if (line.startsWith('process_resident_memory_bytes')) {
                        const match = line.match(/(\d+\.?\d*e?\+?\d*)$/);
                        if (match) memory = parseFloat(match[1]);
                    } else if (line.startsWith('process_start_time_seconds')) {
                        const match = line.match(/(\d+\.?\d*e?\+?\d*)$/);
                        if (match) startTime = parseFloat(match[1]);
                    }
                });
                
                const attempts = total + timeouts;
                const successRate = attempts > 0 ? ((total / attempts) * 100).toFixed(1) : 0;
                const uptime = startTime > 0 ? Date.now() / 1000 - startTime : 0;
                
                document.getElementById('total').textContent = total;
                document.getElementById('timeouts').textContent = timeouts;
                document.getElementById('success-rate').textContent = successRate + '%';
                document.getElementById('inbound').textContent = formatBytes(inbound);
                document.getElementById('outbound').textContent = formatBytes(outbound);
                document.getElementById('memory').textContent = formatBytes(memory);
                document.getElementById('uptime').textContent = formatUptime(uptime);
                
                const table = document.getElementById('countries');
                table.innerHTML = '<tr><th>Country</th><th>Count</th></tr>';
                Object.entries(countries).sort((a, b) => b[1] - a[1]).forEach(([country, count]) => {
                    const row = table.insertRow();
                    const flag = getFlag(country);
                    const displayName = country || 'Unknown';
                    row.insertCell(0).innerHTML = `<span class="flag">${flag}</span>${displayName}`;
                    row.insertCell(1).textContent = count;
                });
            } catch (e) {
                document.getElementById('total').innerHTML = '<span class="error">Error</span>';
            }
        }
        
        fetchStats();
        setInterval(fetchStats, 60000);
    </script>
</body>
</html>
